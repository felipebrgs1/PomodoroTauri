name: Tauri Build

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    build:
        strategy:
            matrix:
                platform: [ubuntu-22.04, windows-latest, macos-latest]
        runs-on: ${{ matrix.platform }}

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Set up Bun
              uses: oven-sh/setup-bun@v1

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install Tauri dependencies (Linux only)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.0-dev build-essential libssl-dev libgtk-3-dev squashfs-tools

            - name: Install JS dependencies
              run: bun install
              working-directory: apps/web

            - name: Build frontend
              run: bun run build
              working-directory: apps/web

            - name: Build Tauri app
              run: bunx tauri build
              working-directory: apps/web

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: tauri-build-${{ matrix.platform }}
                  path: apps/web/src-tauri/target/release/bundle/
